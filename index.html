<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pushup 100</title>
<link rel="manifest" href="manifest.json" />

<style>
  :root{
    --bg:#000;
    --card:#111;
    --card2:#1c1c1e;
    --text:#fff;
    --muted:rgba(255,255,255,.70);
    --muted2:rgba(255,255,255,.45);
    --green:#32d74b;
    --red:#ff453a;
    --amber:#ffcc00;
    --line:rgba(255,255,255,.10);
  }

  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  }

  .wrap{ padding:22px 16px 104px; max-width:560px; margin:0 auto; }

  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    margin:6px 0 14px;
  }
  .title{
    font-size:22px; font-weight:650; letter-spacing:.2px;
  }
  .pill{
    font-size:13px;
    padding:8px 10px;
    border-radius:999px;
    background:var(--card2);
    color:var(--muted);
    border:1px solid var(--line);
  }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:18px;
    padding:16px;
    margin:12px 0;
  }

  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  .label{ color:var(--muted2); font-size:13px; }
  .value{ font-size:34px; font-weight:650; margin-top:6px; }
  .value-sm{ font-size:18px; font-weight:600; }

  .btn{
    width:100%;
    padding:16px 16px;
    border:none;
    border-radius:16px;
    font-size:17px;
    font-weight:600;
  }
  .btn-primary{ background:var(--green); color:#000; }
  .btn-subtle{ background:var(--card2); color:var(--text); border:1px solid var(--line); }
  .btn-danger{ background:rgba(255,69,58,.18); color:var(--text); border:1px solid rgba(255,69,58,.35); }

  .row{
    display:flex; justify-content:space-between; align-items:center;
    gap:10px;
  }

  .tabs{
    position:fixed; left:0; right:0; bottom:0;
    background:rgba(0,0,0,.85);
    backdrop-filter:saturate(180%) blur(18px);
    border-top:1px solid var(--line);
    padding:10px 14px;
    display:flex; gap:10px;
  }
  .tab{
    flex:1;
    padding:12px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:var(--card2);
    color:var(--muted);
    font-weight:600;
    font-size:14px;
    text-align:center;
  }
  .tab.active{
    background:#0b0b0c;
    color:#fff;
    border-color:rgba(255,255,255,.18);
  }

  .hidden{ display:none !important; }

  /* Workout hero */
  .heroWrap{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
  }
  .hero{
    text-align:left;
    padding:6px 0 0;
    flex:1;
  }
  .heroStatus{
    color:var(--muted);
    font-size:15px;
    margin-top:2px;
  }
  .heroBig{
    font-size:58px;
    font-weight:750;
    margin:8px 0 0;
    letter-spacing:-.5px;
  }

  /* Progress ring */
  .ringBox{ width:98px; height:98px; position:relative; flex:0 0 98px; }
  .ringSvg{ width:98px;height:98px; transform:rotate(-90deg); }
  .ringTrack{ stroke:rgba(255,255,255,.10); stroke-width:10; fill:transparent; }
  .ringProgress{
    stroke:var(--green); stroke-width:10; fill:transparent; stroke-linecap:round;
    transition:stroke-dashoffset .25s ease, stroke .25s ease;
  }
  .ringText{
    position:absolute; inset:0;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;
    text-align:center;
  }
  .ringTop{ font-size:13px; font-weight:700; color:rgba(255,255,255,.92); line-height:1; }
  .ringBottom{ font-size:12px; color:var(--muted2); line-height:1; }

  /* Steps list */
  .stepsHeader{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:10px;
  }
  .stepsTitle{ font-size:16px; font-weight:650; }
  .chip{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(50,215,75,.12);
    border:1px solid rgba(50,215,75,.25);
    color:rgba(255,255,255,.85);
  }

  .step{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:#0b0b0c;
    margin:8px 0;
  }
  .stepIcon{
    width:28px; height:28px;
    border-radius:999px;
    background:rgba(255,255,255,.08);
    display:flex; align-items:center; justify-content:center;
    font-size:14px;
  }
  .stepMain{ flex:1; text-align:left; }
  .stepName{ font-weight:650; font-size:14px; }
  .stepSub{ color:var(--muted2); font-size:12px; margin-top:2px; }
  .stepRight{ font-weight:750; font-size:14px; color:rgba(255,255,255,.85); }

  .step.current{ border-color:rgba(50,215,75,.35); background:rgba(50,215,75,.08); }
  .step.done{ opacity:.55; }
  .step.done .stepIcon{ background:rgba(50,215,75,.18); }

  /* History */
  .historyItem{
    display:flex; gap:12px; align-items:flex-start;
    padding:12px 12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:#0b0b0c;
    margin:10px 0;
  }
  .badge{
    min-width:34px; height:34px; border-radius:999px;
    display:flex; align-items:center; justify-content:center;
    font-weight:800;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
  }
  .badge.ok{ background:rgba(50,215,75,.12); border-color:rgba(50,215,75,.25); }
  .badge.hard{ background:rgba(255,204,0,.10); border-color:rgba(255,204,0,.22); }
  .badge.fail{ background:rgba(255,69,58,.12); border-color:rgba(255,69,58,.25); }

  .historyMain{ flex:1; }
  .historyTop{
    display:flex; justify-content:space-between; gap:12px;
    align-items:flex-start;
  }
  .historyTitle{ font-weight:750; }
  .historyMeta{ color:var(--muted2); font-size:12px; margin-top:4px; }
  .historySets{
    color:rgba(255,255,255,.85);
    font-size:13px;
    margin-top:10px;
    line-height:1.35;
  }

  .smallLink{
    color:rgba(255,255,255,.75);
    text-decoration:underline;
    font-size:13px;
    background:transparent;
    border:none;
    padding:0;
  }

  /* Week overview */
  .weekHeader{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
  }
  .weekTitle{
    font-size:18px; font-weight:750;
  }
  .weekNav{
    display:flex; gap:8px;
  }
  .miniBtn{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:var(--card2);
    color:#fff;
    font-weight:700;
    font-size:13px;
  }

  .dayChips{
    display:flex;
    gap:10px;
    margin-top:12px;
  }
  .dayChip{
    flex:1;
    padding:12px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:#0b0b0c;
    text-align:left;
  }
  .dayChipTop{
    display:flex; justify-content:space-between; align-items:center;
  }
  .dayChipTitle{
    font-weight:800;
    font-size:14px;
  }
  .dayChipState{
    font-size:12px;
    color:var(--muted);
    padding:4px 8px;
    border-radius:999px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.10);
  }
  .dayChipState.done{
    color:#000;
    background:rgba(50,215,75,.95);
    border-color:rgba(50,215,75,.95);
  }
  .dayChipState.missed{
    background:rgba(255,69,58,.14);
    border-color:rgba(255,69,58,.25);
    color:rgba(255,255,255,.9);
  }
  .dayChipMeta{
    margin-top:8px;
    font-size:12px;
    color:var(--muted2);
    line-height:1.35;
  }
  .weekSummary{
    display:flex; justify-content:space-between; gap:12px;
    margin-top:14px;
    padding-top:12px;
    border-top:1px solid var(--line);
    color:rgba(255,255,255,.85);
    font-size:13px;
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Pushup 100</div>
      <div class="pill" id="topPill">W1D1 ‚Ä¢ Level 0 ‚Ä¢ üî• 0</div>
    </div>

    <!-- HOME -->
    <div id="screenHome">
      <div class="card">
        <div class="grid">
          <div>
            <div class="label">Baseline (max -2)</div>
            <div class="value" id="baselineVal">25</div>
          </div>
          <div>
            <div class="label">M√•l i dag</div>
            <div class="value" id="todayTarget">0</div>
          </div>
        </div>

        <div style="margin-top:14px" class="row">
          <div class="label">Fase</div>
          <div class="value-sm" id="phaseVal">1</div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="label">Estimat til 100</div>
          <div class="value-sm"><span id="etaVal">?</span> uger</div>
        </div>

        <div style="margin-top:14px" class="row">
          <button class="btn btn-primary" onclick="startWorkout()">Start workout</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btn-subtle" onclick="adjustBaseline()">Juster baseline</button>
        </div>
      </div>

      <div class="card">
        <div class="stepsHeader">
          <div class="stepsTitle">Dagens steps</div>
          <div class="chip" id="stepsChip">0 steps</div>
        </div>
        <div id="planPreview"></div>
        <button class="smallLink" onclick="openPlan()">Se hele step-listen</button>
      </div>
    </div>

    <!-- WORKOUT -->
    <div id="screenWorkout" class="hidden">
      <div class="card">
        <div class="heroWrap">
          <div class="hero">
            <div class="heroStatus" id="workoutStatus">Warmup</div>
            <div class="heroBig" id="workoutMain">5:00</div>
          </div>

          <div class="ringBox" aria-label="Progress">
            <svg class="ringSvg" viewBox="0 0 100 100">
              <circle class="ringTrack" cx="50" cy="50" r="42"></circle>
              <circle class="ringProgress" cx="50" cy="50" r="42" id="ringCircle"></circle>
            </svg>
            <div class="ringText">
              <div class="ringTop"><span id="ringDone">0</span> <span style="opacity:.65">of</span> <span id="ringTotal">0</span></div>
              <div class="ringBottom">reps</div>
            </div>
          </div>
        </div>

        <div id="workoutButtons" style="margin-top:12px">
          <button class="btn btn-primary" id="doneBtn" onclick="tapDone()">Done</button>
          <button class="btn btn-danger" style="margin-top:10px" onclick="confirmEnd()">End workout</button>
        </div>

        <div id="ratingArea" class="hidden" style="margin-top:12px">
          <button class="btn btn-primary" onclick="rateWorkout('easy')">F√∏les let</button>
          <button class="btn btn-subtle" onclick="rateWorkout('ok')">Passende</button>
          <button class="btn" style="background:rgba(255,204,0,.16); border:1px solid rgba(255,204,0,.35); color:#fff" onclick="rateWorkout('hard')">For tungt</button>
          <button class="btn" style="background:rgba(255,69,58,.16); border:1px solid rgba(255,69,58,.35); color:#fff" onclick="rateWorkout('fail')">M√•tte p√• kn√¶ / fail</button>
        </div>
      </div>

      <div class="card">
        <div class="stepsHeader">
          <div class="stepsTitle">Step-liste</div>
          <div class="chip"><span id="progressText">0</span></div>
        </div>
        <div id="stepsList"></div>
      </div>
    </div>

    <!-- PLAN -->
    <div id="screenPlan" class="hidden">
      <div class="card">
        <div class="stepsHeader">
          <div class="stepsTitle">Dagens step-liste</div>
          <div class="chip" id="planTotalChip">Total: 0</div>
        </div>
        <div id="planFull"></div>
        <button class="btn btn-primary" onclick="startWorkout()">Start workout</button>
        <button class="btn btn-subtle" onclick="goHome()">Tilbage</button>
      </div>
    </div>

    <!-- WEEK -->
    <div id="screenWeek" class="hidden">
      <div class="card">
        <div class="weekHeader">
          <div>
            <div class="label">Ugeoversigt</div>
            <div class="weekTitle" id="weekTitle">Week 1</div>
          </div>
          <div class="weekNav">
            <button class="miniBtn" onclick="prevWeek()">‚Äπ</button>
            <button class="miniBtn" onclick="goToCurrentWeek()">Nu</button>
            <button class="miniBtn" onclick="nextWeek()">‚Ä∫</button>
          </div>
        </div>

        <div class="dayChips" id="dayChips"></div>

        <div class="weekSummary">
          <div>Gennemf√∏rt: <b id="weekDone">0/3</b></div>
          <div>Reps: <b id="weekReps">0</b></div>
          <div>Rating: <b id="weekRating">‚Äî</b></div>
        </div>
      </div>

      <div class="card">
        <div class="stepsHeader">
          <div class="stepsTitle">Detaljer</div>
          <div class="chip" id="weekDetailChip">V√¶lg en dag</div>
        </div>
        <div id="weekDetails"></div>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="screenHistory" class="hidden">
      <div class="card">
        <div class="stepsHeader">
          <div class="stepsTitle">Historik</div>
          <div class="chip">Seneste: <span id="historyCount">0</span></div>
        </div>
        <div id="historyList"></div>
        <button class="btn btn-subtle" onclick="clearHistory()">Nulstil historik</button>
      </div>
    </div>

  </div>

  <div class="tabs">
    <div class="tab active" id="tabHome" onclick="showScreen('home')">Home</div>
    <div class="tab" id="tabWorkout" onclick="showScreen('workout')">Workout</div>
    <div class="tab" id="tabWeek" onclick="showScreen('week')">Uge</div>
    <div class="tab" id="tabHistory" onclick="showScreen('history')">Historik</div>
  </div>

<script>
/* -------------------------
   State + persistence
-------------------------- */
let baseline = parseInt(localStorage.getItem("baseline") || "25", 10);
let volumeFactor = parseFloat(localStorage.getItem("volumeFactor") || "2.6");
let streak = parseInt(localStorage.getItem("streak") || "0", 10);
let workouts = JSON.parse(localStorage.getItem("workouts") || "[]");

// Week/Day overlay
let currentWeek = parseInt(localStorage.getItem("currentWeek") || "1", 10);
let currentDay = parseInt(localStorage.getItem("currentDay") || "1", 10); // 1..3

// Week screen state
let selectedWeek = currentWeek;
let selectedDay = 1;

// Active workout runtime
let steps = [];
let currentStepIndex = 0;
let timer = null;
let remaining = 0;
let performedReps = 0;
let plannedTotal = 0;
let activeSessionId = null;

// Ring constants
const RING_R = 42;
const RING_C = 2 * Math.PI * RING_R;

function saveAll(){
  localStorage.setItem("baseline", String(baseline));
  localStorage.setItem("volumeFactor", String(volumeFactor));
  localStorage.setItem("streak", String(streak));
  localStorage.setItem("workouts", JSON.stringify(workouts));
  localStorage.setItem("currentWeek", String(currentWeek));
  localStorage.setItem("currentDay", String(currentDay));
}

function phase(){
  if (baseline < 30) return 1;
  if (baseline < 60) return 2;
  return 3;
}

function weekDayLabel(w=currentWeek, d=currentDay){
  return `W${w}D${d}`;
}

function setActiveTab(which){
  document.getElementById("tabHome").classList.toggle("active", which==="home");
  document.getElementById("tabWorkout").classList.toggle("active", which==="workout");
  document.getElementById("tabWeek").classList.toggle("active", which==="week");
  document.getElementById("tabHistory").classList.toggle("active", which==="history");
}

function showScreen(which){
  if (which==="workout" && !activeSessionId){
    which = "home";
  }

  document.getElementById("screenHome").classList.toggle("hidden", which!=="home");
  document.getElementById("screenWorkout").classList.toggle("hidden", which!=="workout");
  document.getElementById("screenWeek").classList.toggle("hidden", which!=="week");
  document.getElementById("screenHistory").classList.toggle("hidden", which!=="history");
  document.getElementById("screenPlan").classList.add("hidden");

  setActiveTab(which);

  if (which==="history") renderHistory();
  if (which==="week") {
    selectedWeek = selectedWeek || currentWeek;
    renderWeek();
  }
}

function goHome(){ showScreen("home"); }

function hapticShort(){ try{ if (navigator.vibrate) navigator.vibrate(50); }catch(e){} }
function hapticDone(){ try{ if (navigator.vibrate) navigator.vibrate([80,40,80]); }catch(e){} }

function fmtTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}:${s<10?"0":""}${s}`;
}

function updateTopPill(){
  const lvl = Math.floor(baseline / 5);
  document.getElementById("topPill").innerText = `${weekDayLabel()} ‚Ä¢ Level ${lvl} ‚Ä¢ üî• ${streak}`;
}

function estimateWeeksTo100(){
  const recent = workouts.slice(-6).filter(w=>w.completed && w.baselineAfter!=null);
  let weeklyGain = 1.5;
  if (recent.length >= 3){
    const first = recent[0].baselineAfter;
    const last = recent[recent.length-1].baselineAfter;
    const sessions = recent.length-1;
    const gainPerSession = sessions>0 ? (last-first)/sessions : 0;
    weeklyGain = Math.max(0.5, Math.min(3.0, gainPerSession*2.3));
  }
  const remaining = Math.max(0, 100 - baseline);
  return Math.ceil(remaining / weeklyGain);
}

/* -------------------------
   Ring
-------------------------- */
function initRing(){
  const circle = document.getElementById("ringCircle");
  circle.style.strokeDasharray = `${RING_C} ${RING_C}`;
  circle.style.strokeDashoffset = `${RING_C}`;
}
function updateRing(done, total, color=null){
  const circle = document.getElementById("ringCircle");
  const safeTotal = Math.max(1, total || 1);
  const ratio = Math.max(0, Math.min(1, done / safeTotal));
  const offset = RING_C * (1 - ratio);

  document.getElementById("ringDone").innerText = String(done);
  document.getElementById("ringTotal").innerText = String(total);

  circle.style.strokeDashoffset = `${offset}`;
  if (color) circle.style.stroke = color;
  else circle.style.stroke = getComputedStyle(document.documentElement).getPropertyValue('--green').trim();
}

/* -------------------------
   Plan generation
-------------------------- */
function generateSets(total){
  if (phase() === 1){
    const a = Math.round(total * 0.20);
    const b = Math.round(total * 0.22);
    const c = Math.round(total * 0.20);
    const d = total - (a+b+c);
    return [a,b,c,d];
  }
  if (phase() === 2){
    const a = Math.round(total * 0.22);
    const b = Math.round(total * 0.20);
    const c = Math.round(total * 0.18);
    const d = Math.round(total * 0.18);
    const e = total - (a+b+c+d);
    return [a,b,c,d,e];
  }
  const a = Math.round(total * 0.38);
  const b = Math.round(total * 0.26);
  const c = Math.round(total * 0.18);
  const d = total - (a+b+c);
  return [a,b,c,d];
}

function buildSteps(){
  const total = Math.max(10, Math.round(baseline * volumeFactor));
  const setsArr = generateSets(total);
  plannedTotal = setsArr.reduce((s,x)=>s+x,0);

  const s = [];
  s.push({ id: cryptoId(), type:"warmup", label:"Warmup", seconds:300 });

  for (let i=0;i<setsArr.length;i++){
    s.push({ id: cryptoId(), type:"set", label:`Set ${i+1}`, reps:setsArr[i] });
    if (i < setsArr.length-1){
      s.push({ id: cryptoId(), type:"rest", label:"Rest", seconds:120 });
    }
  }
  s.push({ id: cryptoId(), type:"done", label:"Complete", seconds:0 });
  steps = s;

  return { total, setsArr };
}

function cryptoId(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

/* -------------------------
   Home render
-------------------------- */
function stepRowHtml(st){
  const icon = st.type==="warmup" ? "‚è≥" : (st.type==="rest" ? "‚è±" : (st.type==="set" ? "‚ñ∂Ô∏é" : "‚úì"));
  const right = st.type==="set" ? `${st.reps}` : (st.type==="warmup"||st.type==="rest" ? fmtTime(st.seconds) : "");
  const sub = st.type==="set" ? "Pushups" : (st.type==="rest" ? "Rest" : "Warmup");
  return `
    <div class="step">
      <div class="stepIcon">${icon}</div>
      <div class="stepMain">
        <div class="stepName">${st.label}</div>
        <div class="stepSub">${sub}</div>
      </div>
      <div class="stepRight">${right}</div>
    </div>
  `;
}

function renderHome(){
  updateTopPill();
  document.getElementById("baselineVal").innerText = baseline;
  document.getElementById("phaseVal").innerText = phase();
  document.getElementById("todayTarget").innerText = Math.round(baseline * volumeFactor);
  document.getElementById("etaVal").innerText = estimateWeeksTo100();

  buildSteps();
  document.getElementById("stepsChip").innerText = `${steps.length} steps ‚Ä¢ ${plannedTotal} reps`;
  document.getElementById("planPreview").innerHTML = steps.slice(0,6).map(stepRowHtml).join("");
}

function openPlan(){
  buildSteps();
  document.getElementById("screenHome").classList.add("hidden");
  document.getElementById("screenWorkout").classList.add("hidden");
  document.getElementById("screenWeek").classList.add("hidden");
  document.getElementById("screenHistory").classList.add("hidden");
  document.getElementById("screenPlan").classList.remove("hidden");
  setActiveTab("home");

  document.getElementById("planTotalChip").innerText = `Total: ${plannedTotal} reps`;
  document.getElementById("planFull").innerHTML = steps.map(stepRowHtml).join("");
}

/* -------------------------
   Workout flow
-------------------------- */
function startWorkout(){
  buildSteps();
  performedReps = 0;
  currentStepIndex = 0;
  activeSessionId = cryptoId();

  const now = new Date();
  workouts.push({
    id: activeSessionId,
    week: currentWeek,
    day: currentDay,
    weekDay: weekDayLabel(currentWeek, currentDay),
    dateISO: now.toISOString(),
    plannedTotal,
    performedReps: 0,
    sets: steps.filter(s=>s.type==="set").map(s=>s.reps),
    completed: false,
    rating: null,
    baselineBefore: baseline,
    baselineAfter: null,
    volumeFactorBefore: volumeFactor,
    volumeFactorAfter: null,
    phase: phase()
  });
  saveAll();

  document.getElementById("screenHome").classList.add("hidden");
  document.getElementById("screenPlan").classList.add("hidden");
  document.getElementById("screenWeek").classList.add("hidden");
  document.getElementById("screenHistory").classList.add("hidden");
  document.getElementById("screenWorkout").classList.remove("hidden");
  setActiveTab("workout");

  document.getElementById("ratingArea").classList.add("hidden");
  document.getElementById("workoutButtons").classList.remove("hidden");
  document.getElementById("doneBtn").classList.remove("hidden");

  updateRing(0, plannedTotal);
  renderStepsList();
  runCurrentStep();
}

function renderStepsList(){
  const totalSets = steps.filter(s=>s.type==="set").length;
  const doneSets = steps.slice(0, currentStepIndex).filter(s=>s.type==="set").length;
  document.getElementById("progressText").innerText = `${weekDayLabel()} ‚Ä¢ ${doneSets}/${totalSets} sets ‚Ä¢ ${performedReps}/${plannedTotal} reps`;

  document.getElementById("stepsList").innerHTML = steps.map((s, idx)=>{
    const icon = s.type==="warmup" ? "‚è≥" : (s.type==="rest" ? "‚è±" : (s.type==="set" ? "‚ñ∂Ô∏é" : "‚úì"));
    const right = s.type==="set" ? `${s.reps}` : (s.type==="warmup"||s.type==="rest" ? fmtTime(s.seconds) : "");
    const sub = s.type==="set" ? "Pushups" : (s.type==="rest" ? "Rest" : (s.type==="warmup" ? "Warmup" : "Finish"));
    let cls = "step";
    if (idx === currentStepIndex) cls += " current";
    if (idx < currentStepIndex) cls += " done";
    return `
      <div class="${cls}">
        <div class="stepIcon">${idx < currentStepIndex ? "‚úì" : icon}</div>
        <div class="stepMain">
          <div class="stepName">${s.label}</div>
          <div class="stepSub">${sub}</div>
        </div>
        <div class="stepRight">${right}</div>
      </div>
    `;
  }).join("");
}

function runCurrentStep(){
  clearTimer();
  const st = steps[currentStepIndex];
  if (!st){ finishWorkoutUI(); return; }

  if (st.type === "warmup"){
    document.getElementById("workoutStatus").innerText = `${weekDayLabel()} ‚Ä¢ Warmup`;
    document.getElementById("doneBtn").classList.add("hidden");
    startTimer(st.seconds, ()=>{ hapticDone(); nextStep(); });
    return;
  }

  if (st.type === "rest"){
    document.getElementById("workoutStatus").innerText = `${weekDayLabel()} ‚Ä¢ Rest`;
    document.getElementById("doneBtn").classList.add("hidden");
    startTimer(st.seconds, ()=>{ hapticDone(); nextStep(); });
    return;
  }

  if (st.type === "set"){
    document.getElementById("workoutStatus").innerText = `${weekDayLabel()} ‚Ä¢ ${st.label}`;
    document.getElementById("workoutMain").innerText = String(st.reps);
    document.getElementById("doneBtn").classList.remove("hidden");
    return;
  }

  finishWorkoutUI();
}

function startTimer(seconds, onDone){
  remaining = seconds;
  document.getElementById("workoutMain").innerText = fmtTime(remaining);
  timer = setInterval(()=>{
    remaining--;
    document.getElementById("workoutMain").innerText = fmtTime(Math.max(0, remaining));
    if (remaining <= 0){
      clearTimer();
      onDone();
    }
  }, 1000);
}

function clearTimer(){
  if (timer){ clearInterval(timer); timer = null; }
}

function tapDone(){
  const st = steps[currentStepIndex];
  if (!st || st.type !== "set") return;

  performedReps += st.reps;
  hapticShort();

  updateRing(performedReps, plannedTotal);

  const sess = workouts.find(w=>w.id===activeSessionId);
  if (sess){
    sess.performedReps = performedReps;
    saveAll();
  }

  nextStep();
}

function nextStep(){
  currentStepIndex++;
  renderStepsList();
  runCurrentStep();
  renderStepsList();
}

function finishWorkoutUI(){
  clearTimer();
  document.getElementById("workoutStatus").innerText = `${weekDayLabel()} ‚Ä¢ Workout complete`;
  document.getElementById("workoutMain").innerText = "üî•";
  document.getElementById("workoutButtons").classList.add("hidden");
  document.getElementById("ratingArea").classList.remove("hidden");
  hapticDone();
  renderStepsList();
}

function confirmEnd(){
  const ok = confirm("Vil du afslutte workout? Den bliver gemt som uf√¶rdig.");
  if (!ok) return;

  clearTimer();

  const sess = workouts.find(w=>w.id===activeSessionId);
  if (sess){
    sess.completed = false;
    sess.rating = "ended";
    sess.performedReps = performedReps;
    saveAll();
  }

  activeSessionId = null;
  steps = [];
  currentStepIndex = 0;
  performedReps = 0;
  plannedTotal = 0;

  showScreen("home");
  renderHome();
}

/* -------------------------
   Rating + week/day advance
-------------------------- */
function advanceWeekDay(){
  currentDay += 1;
  if (currentDay > 3){
    currentDay = 1;
    currentWeek += 1;
  }
}

function rateWorkout(level){
  if (level === "easy"){
    volumeFactor *= 1.03;
    baseline += 1;
    streak += 1;
    updateRing(performedReps, plannedTotal, getCss('--green'));
  } else if (level === "ok"){
    volumeFactor *= 1.015;
    streak += 1;
    updateRing(performedReps, plannedTotal, getCss('--green'));
  } else if (level === "hard"){
    volumeFactor *= 0.99;
    streak = 0;
    updateRing(performedReps, plannedTotal, getCss('--amber'));
  } else if (level === "fail"){
    volumeFactor *= 0.95;
    streak = 0;
    updateRing(performedReps, plannedTotal, getCss('--red'));
  }

  volumeFactor = Math.max(1.6, Math.min(4.0, volumeFactor));
  baseline = Math.max(1, baseline);

  const sess = workouts.find(w=>w.id===activeSessionId);
  if (sess){
    sess.completed = true;
    sess.rating = level;
    sess.baselineAfter = baseline;
    sess.volumeFactorAfter = volumeFactor;
    sess.performedReps = performedReps;
  }

  advanceWeekDay();
  saveAll();

  activeSessionId = null;
  steps = [];
  currentStepIndex = 0;
  performedReps = 0;
  plannedTotal = 0;

  showScreen("home");
  renderHome();
}

function getCss(v){
  return getComputedStyle(document.documentElement).getPropertyValue(v).trim();
}

/* -------------------------
   Week overview
-------------------------- */
function goToCurrentWeek(){
  selectedWeek = currentWeek;
  selectedDay = currentDay;
  renderWeek();
}

function prevWeek(){
  selectedWeek = Math.max(1, selectedWeek - 1);
  selectedDay = 1;
  renderWeek();
}

function nextWeek(){
  selectedWeek = selectedWeek + 1;
  selectedDay = 1;
  renderWeek();
}

function ratingText(r){
  if (r==="easy") return "Let";
  if (r==="ok") return "OK";
  if (r==="hard") return "H√•rd";
  if (r==="fail") return "Fail";
  if (r==="ended") return "Afsluttet";
  return "‚Äî";
}

function weekDayState(w, d){
  // pick the latest session for that week/day (if multiple)
  const wd = `W${w}D${d}`;
  const matches = workouts.filter(x => (x.weekDay===wd) || (x.week===w && x.day===d));
  if (matches.length===0) return null;
  matches.sort((a,b)=> (a.dateISO<b.dateISO?1:-1));
  return matches[0];
}

function renderWeek(){
  updateTopPill();
  document.getElementById("weekTitle").innerText = `Week ${selectedWeek}`;

  // build chips
  const chips = [];
  let doneCount = 0;
  let sumReps = 0;
  const ratings = [];

  for (let d=1; d<=3; d++){
    const sess = weekDayState(selectedWeek, d);
    const isToday = (selectedWeek===currentWeek && d===currentDay);
    const selected = (d===selectedDay);

    let stateLabel = isToday ? "Today" : "‚Äî";
    let stateClass = "";
    let meta = "Ingen data endnu";

    if (sess){
      const completed = !!sess.completed && (sess.rating!=="ended");
      if (completed){
        stateLabel = "‚úì";
        stateClass = "done";
        doneCount++;
        sumReps += (sess.performedReps || 0);
        ratings.push(sess.rating);
      } else {
        stateLabel = "‚Äî";
        meta = `Uf√¶rdig ‚Ä¢ ${sess.performedReps||0}/${sess.plannedTotal||0} reps`;
      }

      meta = `Reps ${sess.performedReps||0}/${sess.plannedTotal||0} ‚Ä¢ ${ratingText(sess.rating)}`;
    }

    chips.push(`
      <div class="dayChip" style="${selected?'border-color:rgba(255,255,255,.22)':''}" onclick="selectDay(${d})">
        <div class="dayChipTop">
          <div class="dayChipTitle">D${d}</div>
          <div class="dayChipState ${stateClass}">${stateLabel}</div>
        </div>
        <div class="dayChipMeta">${meta}</div>
      </div>
    `);
  }

  document.getElementById("dayChips").innerHTML = chips.join("");

  document.getElementById("weekDone").innerText = `${doneCount}/3`;
  document.getElementById("weekReps").innerText = `${sumReps}`;
  document.getElementById("weekRating").innerText =
    ratings.length ? ratingText(mostCommon(ratings)) : "‚Äî";

  renderWeekDetails();
}

function mostCommon(arr){
  const m = new Map();
  arr.forEach(x=>m.set(x,(m.get(x)||0)+1));
  let best=null, bestN=-1;
  for (const [k,v] of m.entries()){
    if (v>bestN){ best=k; bestN=v; }
  }
  return best;
}

function selectDay(d){
  selectedDay = d;
  renderWeek();
}

function renderWeekDetails(){
  const sess = weekDayState(selectedWeek, selectedDay);
  const chip = document.getElementById("weekDetailChip");
  const box = document.getElementById("weekDetails");

  const wd = `W${selectedWeek}D${selectedDay}`;
  chip.innerText = wd;

  if (!sess){
    box.innerHTML = `<div class="label">Ingen workout gemt for ${wd} endnu.</div>`;
    return;
  }

  const d = new Date(sess.dateISO);
  const dateText = d.toLocaleDateString("da-DK", { year:"numeric", month:"2-digit", day:"2-digit" });
  const timeText = d.toLocaleTimeString("da-DK", { hour:"2-digit", minute:"2-digit" });

  const setsText = (sess.sets && sess.sets.length) ? sess.sets.join("  ") : "‚Äî";

  box.innerHTML = `
    <div class="historyItem">
      <div class="badge ${sess.rating==='fail' || sess.rating==='ended' ? 'fail' : (sess.rating==='hard' ? 'hard' : 'ok')}">
        ${sess.rating==='fail' ? '√ó' : (sess.rating==='hard' ? '!' : (sess.rating==='ended' ? '‚èπ' : '‚úì'))}
      </div>
      <div class="historyMain">
        <div class="historyTop">
          <div>
            <div class="historyTitle">${wd} ‚Ä¢ ${dateText} ${timeText}</div>
            <div class="historyMeta">Phase ${sess.phase ?? "-"} ‚Ä¢ ${ratingText(sess.rating)} ‚Ä¢ Baseline ${sess.baselineBefore ?? "-"} ‚Üí ${sess.baselineAfter ?? sess.baselineBefore ?? "-"}</div>
          </div>
          <div style="text-align:right">
            <div class="historyTitle">${sess.performedReps||0}/${sess.plannedTotal||0}</div>
            <div class="historyMeta">reps</div>
          </div>
        </div>
        <div class="historySets">Sets: ${setsText}</div>
      </div>
    </div>
  `;
}

/* -------------------------
   History screen
-------------------------- */
function renderHistory(){
  updateTopPill();

  const list = workouts.slice().reverse();
  document.getElementById("historyCount").innerText = String(list.length);

  if (list.length === 0){
    document.getElementById("historyList").innerHTML = `<div class="label">Ingen tr√¶ninger endnu. Start en workout fra Home.</div>`;
    return;
  }

  const html = list.map(w=>{
    const d = new Date(w.dateISO);
    const dateText = d.toLocaleDateString("da-DK", { year:"numeric", month:"2-digit", day:"2-digit" });
    const timeText = d.toLocaleTimeString("da-DK", { hour:"2-digit", minute:"2-digit" });

    let badgeClass = "ok";
    let badgeChar = "‚úì";
    let ratingTxt = "OK";

    if (w.rating === "easy"){ badgeClass="ok"; badgeChar="‚úì"; ratingTxt="Let"; }
    if (w.rating === "ok"){ badgeClass="ok"; badgeChar="‚úì"; ratingTxt="Passende"; }
    if (w.rating === "hard"){ badgeClass="hard"; badgeChar="!"; ratingTxt="H√•rd"; }
    if (w.rating === "fail"){ badgeClass="fail"; badgeChar="√ó"; ratingTxt="Fail/kn√¶"; }
    if (w.rating === "ended"){ badgeClass="fail"; badgeChar="‚èπ"; ratingTxt="Afsluttet"; }

    const planned = w.plannedTotal ?? 0;
    const performed = w.performedReps ?? 0;
    const setsText = (w.sets && w.sets.length) ? w.sets.join("  ") : "";
    const wd = w.weekDay || (w.week && w.day ? `W${w.week}D${w.day}` : "‚Äî");

    return `
      <div class="historyItem">
        <div class="badge ${badgeClass}">${badgeChar}</div>
        <div class="historyMain">
          <div class="historyTop">
            <div>
              <div class="historyTitle">${wd} ‚Ä¢ ${dateText} ${timeText}</div>
              <div class="historyMeta">Phase ${w.phase ?? "-"} ‚Ä¢ ${ratingTxt} ‚Ä¢ Baseline ${w.baselineBefore ?? "-"} ‚Üí ${w.baselineAfter ?? w.baselineBefore ?? "-"}</div>
            </div>
            <div style="text-align:right">
              <div class="historyTitle">${performed}/${planned}</div>
              <div class="historyMeta">reps</div>
            </div>
          </div>
          <div class="historySets">Sets: ${setsText || "<span style='color:rgba(255,255,255,.45)'>-</span>"}</div>
        </div>
      </div>
    `;
  }).join("");

  document.getElementById("historyList").innerHTML = html;
}

function clearHistory(){
  const ok = confirm("Nulstil historik? Det kan ikke fortrydes.");
  if (!ok) return;
  workouts = [];
  saveAll();
  renderHistory();
}

/* -------------------------
   Baseline adjust
-------------------------- */
function adjustBaseline(){
  const val = prompt("Ny baseline (max -2):", String(baseline));
  if (!val) return;
  const n = parseInt(val, 10);
  if (!Number.isFinite(n) || n < 1) return;
  baseline = n;
  saveAll();
  renderHome();
}

/* -------------------------
   Init
-------------------------- */
initRing();
renderHome();
showScreen("home");
</script>
</body>
</html>